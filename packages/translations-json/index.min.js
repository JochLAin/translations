"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},__assign.apply(this,arguments)},__createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,a){void 0===a&&(a=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,a,n)}:function(e,t,r,a){void 0===a&&(a=r),e[a]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var helper_module_imports_1=require("@babel/helper-module-imports"),BabelTypes=__importStar(require("@babel/types")),translations_1=require("@jochlain/translations"),babel_plugin_macros_1=require("babel-plugin-macros"),fs=__importStar(require("fs")),intl_messageformat_1=__importDefault(require("intl-messageformat")),path=__importStar(require("path")),AVAILABLE_METHODS=["createTranslator","translate"],DEFAULT_ROOT_DIR="translations",INTL_IDENTIFIER="jochlain_translation_intl_formatter",MACRO_CREATE_TRANSLATOR_AVAILABLE_OPTION_KEYS=["domain","host","locale"],MACRO_CREATE_TRANSLATOR_SIGNATURE="createTranslator({ domain?: string, host?: string, locale?: identifier|string })",MACRO_TRANSLATE_AVAILABLE_OPTION_KEYS=["domain","host","locale"],MACRO_TRANSLATE_SIGNATURE="translate(message: identifier|string, replacements: identifier|{ [key: string]: number|string }, { domain: string = 'messages', locale: identifier|string = 'en', host?: string })",IMPORT_OPTIONS={importedType:"commonjs",importedInterop:"babel",importingInterop:"babel"},formatter={format:function(e,t,r){return String(new intl_messageformat_1.default(e,r).format(t))}},programMap=new Map,cache=new(function(){function e(){this.watched=!1,this.buffer=new Map}return e.prototype.get=function(e){return this.buffer.get(e)},e.prototype.set=function(e,t){this.buffer.set(e,t)},e.prototype.watch=function(e){var t=this;this.watched||(this.watched=!0,fs.watch(e,{recursive:!0},(function(e,r){if("change"===e)for(var a=Array.from(t.buffer.keys()),n=0;n<a.length;n++)r.includes(a[n])&&t.buffer.delete(a[n])})))},e}()),searchModule=function(e,t,r,a){void 0===a&&(a=!1);var n=getProgramPath(e),i=(0,helper_module_imports_1.isModule)(n),o=i&&"node"===IMPORT_OPTIONS.importingInterop,s=i&&"babel"===IMPORT_OPTIONS.importingInterop;if("es6"===IMPORT_OPTIONS.importedType)return searchModuleInImport(e,t,r,a);if("commonjs"===IMPORT_OPTIONS.importedType){if(["babel","compiled","uncompiled"].includes(IMPORT_OPTIONS.importedInterop))return o||s?searchModuleInImport(e,t,r,a):null;throw new Error('Unknown importedInterop "'.concat(IMPORT_OPTIONS.importedInterop,'".'))}throw new Error('Unexpected interopType "'.concat(IMPORT_OPTIONS.importedType,'"'))},searchModuleInImport=function(e,t,r,a){void 0===a&&(a=!1);for(var n=getProgramBody(e),i=0;i<n.length;i++){if(!BabelTypes.isImportDeclaration(n[i].node))return null;var o=n[i].node;if(o.source.value===t)for(var s=0;s<o.specifiers.length;s++){var l=o.specifiers[s];if(a){if(BabelTypes.isImportDefaultSpecifier(l))throw new Error("Can't fully support default import")}else if(BabelTypes.isImportSpecifier(l)&&l.local.name===r)return BabelTypes.isStringLiteral(l.imported)?BabelTypes.identifier(l.imported.value):l.imported}}return null},getProgramPath=function(e){if(!programMap.has(e)){var t=e.find((function(e){return e.isProgram()}));if(!t)throw e.parentPath?e.parentPath.buildCodeFrameError("Can't reach program node",babel_plugin_macros_1.MacroError):new Error("Can't reach program node");programMap.set(e,t)}return programMap.get(e)},getProgramBody=function(e){var t=getProgramPath(e).get("body");return Array.isArray(t)?t:[t]},insertImport=function(e,t){for(var r=getProgramBody(e),a=r.length-1;a>=0;a--)if(r[a].isImportDeclaration())return void r[a].insertAfter(t);r[0].insertBefore(t)},getModule=function(e,t,r,a){void 0===a&&(a=!1);var n=searchModule(e,t,r,a);return n||(a?(0,helper_module_imports_1.addDefault)(e.parentPath,t,__assign(__assign({},IMPORT_OPTIONS),{nameHint:r})):(0,helper_module_imports_1.addNamed)(e.parentPath,r,t,__assign(__assign({},IMPORT_OPTIONS),{nameHint:r})))},AbstractMacro=function(){function e(e,t,r){this.types=e,this.loader=t,this.options=r}return e.prototype.createIntlFormatter=function(e){for(var t=getProgramBody(e),r=0;r<t.length;r++)if(this.types.isVariableDeclaration(t[r].node))for(var a=t[r].node,n=0;n<a.declarations.length;n++){var i=a.declarations[n];if(this.types.isIdentifier(i.id)&&i.id.name===INTL_IDENTIFIER)return i.id}var o=getModule(e,"intl-messageformat","IntlMessageFormat"),s=this.types.identifier(INTL_IDENTIFIER),l=this.types.identifier("locale"),p=this.types.identifier("message"),c=this.types.identifier("replacements");return insertImport(e,this.types.variableDeclaration("const",[this.types.variableDeclarator(s,this.types.objectExpression([this.types.objectProperty(this.types.identifier("format"),this.types.arrowFunctionExpression([p,c,l],this.types.blockStatement([this.types.returnStatement(this.types.callExpression(this.types.memberExpression(this.types.parenthesizedExpression(this.types.newExpression(o,[p,l])),this.types.identifier("format")),[c]))])))]))])),s},e.prototype.getCatalogs=function(e,t,r,a){var n="".concat(path.relative(process.cwd(),t),"/").concat(r||"","/").concat(a||"");if(!cache.get(n)){for(var i=this.getFiles(e,t,r,a),o={},s=0;s<i.length;s++)Object.assign(o,(0,translations_1.mergeCatalogs)(o,this.load(t,i[s])));cache.set(n,o)}return cache.get(n)},e.prototype.getFiles=function(e,t,r,a){var n=this;try{if(fs.lstatSync(t).isDirectory())return fs.readdirSync(t).filter((function(e){return n.testFile(e,r,a)}))}catch(e){}throw e.parentPath.buildCodeFrameError("Host parameter must refer to a directory",babel_plugin_macros_1.MacroError)},e.prototype.load=function(e,t){var r,a,n=this.matchFile(t),i=n[0],o=n[1],s=path.relative(process.cwd(),path.join(e,t));if(!cache.get(s)){var l=path.join(e,t),p=fs.readFileSync(l).toString();cache.set(s,this.loader.load(p))}return(r={})[o]=((a={})[i]=cache.get(s),a),r},e.prototype.matchFile=function(e){var t=e.split(".").reverse(),r=t[0],a=t[1];return[t.slice(2).join("."),a,r]},e.prototype.testFile=function(e,t,r){var a=this.matchFile(e),n=a[0],i=a[1],o=a[2];return(!t||n===t)&&((!r||i===r)&&this.loader.extension.test(".".concat(o)))},e}(),CreateTranslatorMacro=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.buildNode=function(e){if(null!==e){var t=this.getOptions(e),r=t.domain,a=t.host,n=t.locale,i=a?path.join(this.options.rootDir,a):this.options.rootDir,o=getModule(e,"@jochlain/translations","createTranslator"),s=this.getCatalogs(e,i,r,n),l=[this.types.objectProperty(this.types.identifier("formatter"),this.createIntlFormatter(e))];return n&&l.push(this.types.objectProperty(this.types.identifier("locale"),this.types.stringLiteral(n))),r&&l.push(this.types.objectProperty(this.types.identifier("domain"),this.types.stringLiteral(r))),this.types.callExpression(o,[this.types.valueToNode(s),this.types.objectExpression(l)])}},t.prototype.getOptions=function(e){var t=this;if(e.node.arguments.length>1)throw e.parentPath.buildCodeFrameError("Received an invalid number of arguments (must be 0 or 1)\n  Signature: ".concat(MACRO_CREATE_TRANSLATOR_SIGNATURE),babel_plugin_macros_1.MacroError);if(!e.node.arguments.length)return{};if(!this.types.isObjectExpression(e.node.arguments[0]))throw e.parentPath.buildCodeFrameError("Parameter must be an object\n  Signature: ".concat(MACRO_CREATE_TRANSLATOR_SIGNATURE),babel_plugin_macros_1.MacroError);return e.node.arguments[0].properties.reduce((function(r,a){var n;if(!t.types.isObjectProperty(a))throw e.parentPath.buildCodeFrameError("Method option parameter must be an object of strings\n  Signature: ".concat(MACRO_CREATE_TRANSLATOR_SIGNATURE),babel_plugin_macros_1.MacroError);if(!t.types.isIdentifier(a.key)&&!t.types.isStringLiteral(a.key))throw e.parentPath.buildCodeFrameError("Method option parameter has an invalid key\n  Signature: ".concat(MACRO_CREATE_TRANSLATOR_SIGNATURE),babel_plugin_macros_1.MacroError);var i=t.types.isIdentifier(a.key)?a.key.name:a.key.value;if(!MACRO_CREATE_TRANSLATOR_AVAILABLE_OPTION_KEYS.includes(i))throw e.parentPath.buildCodeFrameError("Option ".concat(i," is not allowed\n  Signature: ").concat(MACRO_CREATE_TRANSLATOR_SIGNATURE),babel_plugin_macros_1.MacroError);if(!t.types.isStringLiteral(a.value))throw e.parentPath.buildCodeFrameError("Option ".concat(i," must be a string\n  Signature: ").concat(MACRO_CREATE_TRANSLATOR_SIGNATURE),babel_plugin_macros_1.MacroError);return __assign(__assign({},r),((n={})[i]=a.value.value,n))}),{})},t}(AbstractMacro),TranslateMacro=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.buildNode=function(e){if(e)return!this.hasReplacementIdentifier(e)&&this.isLocaleLiteral(e)?this.buildNodeWithLiteral(e):this.buildNodeWithIdentifier(e)},t.prototype.buildNodeWithIdentifier=function(e){var t=this.getArguments(e),r=t.catalog,a=t.locale,n=getModule(e,"@jochlain/translations","translate");return this.types.callExpression(n,[this.types.valueToNode(r),this.getNodeReplacement(e),this.isLocaleLiteral(e)?this.types.stringLiteral(a):this.types.identifier(a),this.createIntlFormatter(e)])},t.prototype.buildNodeWithLiteral=function(e){var t=this.getArguments(e),r=t.catalog,a=t.locale,n=this.getArgumentReplacements(e),i=(0,translations_1.translate)(r,n,a,formatter);return this.types.stringLiteral(i)},t.prototype.getArguments=function(e){var t,r=this.getArgumentMessage(e),a=this.getOptions(e),n=a.domain,i=a.host,o=a.locale,s=i?path.resolve(this.options.rootDir,i):this.options.rootDir;if(this.isLocaleLiteral(e)){var l=this.getCatalogs(e,s,n,o),p=r;return l&&l[o]&&l[o][n]&&(p=(0,translations_1.getCatalogValue)(l[o][n],r)),{catalog:((t={})[o]=p,t),locale:o}}var c=this.getCatalogs(e,s,n),u=Object.keys(c).reduce((function(e,t){var a;return __assign(__assign({},e),((a={})[t]=(0,translations_1.getCatalogValue)(c[t][n],r),a))}),{});return{catalog:u,locale:o}},t.prototype.getArgumentMessage=function(e){return e.node.arguments[0].value},t.prototype.getArgumentReplacements=function(e){var t=this;if(e.node.arguments.length<=1)return{};if(this.types.isNullLiteral(e.node.arguments[1]))return{};if(!this.types.isObjectExpression(e.node.arguments[1]))throw e.parentPath.buildCodeFrameError("Replacement argument is not an object",babel_plugin_macros_1.MacroError);return e.node.arguments[1].properties.reduce((function(r,a){var n,i,o;if(!t.types.isObjectProperty(a))return r;if(!a)return r;if(!t.types.isIdentifier(a.key)&&!t.types.isStringLiteral(a.key))throw e.parentPath.buildCodeFrameError("Replacements option parameter has an invalid key",babel_plugin_macros_1.MacroError);var s=a.key,l=a.value,p=s.value;if(t.types.isIdentifier(s)&&(p=s.name),t.types.isStringLiteral(l))return __assign(__assign({},r),((n={})[p]=l.value,n));if(t.types.isNumericLiteral(l))return __assign(__assign({},r),((i={})[p]=l.value,i));if(t.types.isIdentifier(l))return __assign(__assign({},r),((o={})[p]=l.name,o));throw e.parentPath.buildCodeFrameError("Replacements option parameter must be an object of string, number or variables",babel_plugin_macros_1.MacroError)}),{})},t.prototype.getOptions=function(e){var t=this;if(e.node.arguments.length>3)throw e.parentPath.buildCodeFrameError("Received an invalid number of arguments.\n Signature: ".concat(MACRO_TRANSLATE_SIGNATURE),babel_plugin_macros_1.MacroError);if(!e.node.arguments.length)throw e.parentPath.buildCodeFrameError("Message argument is mandatory.\n Signature: ".concat(MACRO_TRANSLATE_SIGNATURE),babel_plugin_macros_1.MacroError);if(!this.types.isStringLiteral(e.node.arguments[0]))throw e.parentPath.buildCodeFrameError("Message argument must be a string.\nIf you want to use variable for domain, please use createTranslator instead.\n Signature: ".concat(MACRO_TRANSLATE_SIGNATURE),babel_plugin_macros_1.MacroError);if(e.node.arguments[2]&&!this.types.isObjectExpression(e.node.arguments[2]))throw e.parentPath.buildCodeFrameError("Options argument is not a object.\n Signature: ".concat(MACRO_TRANSLATE_SIGNATURE),babel_plugin_macros_1.MacroError);var r=((e.node.arguments[2]?e.node.arguments[2].properties:[])||[]).reduce((function(r,a){var n,i,o;if(!t.types.isObjectProperty(a))throw e.parentPath.buildCodeFrameError("Method option parameter must be an object of strings",babel_plugin_macros_1.MacroError);if(!t.types.isIdentifier(a.key)&&!t.types.isStringLiteral(a.key))throw e.parentPath.buildCodeFrameError("Method option parameter has an invalid key",babel_plugin_macros_1.MacroError);var s=t.types.isIdentifier(a.key)?a.key.name:a.key.value;if(!MACRO_TRANSLATE_AVAILABLE_OPTION_KEYS.includes(s))throw e.parentPath.buildCodeFrameError("Option ".concat(s," is not allowed"),babel_plugin_macros_1.MacroError);if("locale"===s){if(t.types.isStringLiteral(a.value))return __assign(__assign({},r),((n={})[s]=a.value.value,n));if(t.types.isIdentifier(a.value))return __assign(__assign({},r),((i={})[s]=a.value.name,i));throw e.parentPath.buildCodeFrameError("Option ".concat(s," must be a string or a variable"),babel_plugin_macros_1.MacroError)}if(!t.types.isStringLiteral(a.value))throw e.parentPath.buildCodeFrameError("Option ".concat(s," must be a string"),babel_plugin_macros_1.MacroError);return __assign(__assign({},r),((o={})[s]=a.value.value,o))}),{});return Object.assign({domain:"messages",host:void 0,locale:"en"},r)},t.prototype.getNodeReplacement=function(e){if(e.node.arguments.length<=1)return this.types.objectExpression([]);if(this.types.isNullLiteral(e.node.arguments[1]))return this.types.objectExpression([]);if(!this.types.isObjectExpression(e.node.arguments[1]))throw e.parentPath.buildCodeFrameError("Replacement argument is not an object",babel_plugin_macros_1.MacroError);return e.node.arguments[1]},t.prototype.hasReplacementIdentifier=function(e){if(e.node.arguments.length<=1)return!1;if(this.types.isNullLiteral(e.node.arguments[1]))return!1;if(!this.types.isObjectExpression(e.node.arguments[1]))return!1;for(var t=e.node.arguments[1].properties,r=0;r<t.length;r++)if(this.types.isObjectProperty(t[r])){var a=t[r];if(!this.types.isIdentifier(a.key)&&!this.types.isStringLiteral(a.key))return!1;if(this.types.isIdentifier(a.value))return!0}return!1},t.prototype.isLocaleLiteral=function(e){if(!e.node.arguments[2])return!0;if(!this.types.isObjectExpression(e.node.arguments[2]))return!1;for(var t=0;t<e.node.arguments[2].properties.length;t++){var r=e.node.arguments[2].properties[t];if(this.types.isObjectProperty(r))if(this.types.isIdentifier(r.key)||this.types.isStringLiteral(r.key))if("locale"===(this.types.isIdentifier(r.key)?r.key.name:r.key.value))return this.types.isStringLiteral(r.value)}return!0},t}(AbstractMacro),createTranslatorMacro=function(e,t,r){return new CreateTranslatorMacro(e,t,r)},createTranslateMacro=function(e,t,r){return new TranslateMacro(e,t,r)},getOptions=function(e){var t=Object.assign({rootDir:DEFAULT_ROOT_DIR},e);return Object.assign(t,{rootDir:path.resolve(process.cwd(),t.rootDir)})};exports.default=function(e){return function(t){var r=t.babel,a=t.config,n=t.references,i=r.types,o=getOptions(a),s=createTranslatorMacro(i,e,o),l=createTranslateMacro(i,e,o);o.watch&&cache.watch(o.rootDir),Object.keys(n).forEach((function(e){n[e].forEach((function(t){if(t.parentPath){if(!i.isCallExpression(t.parentPath.node))throw t.parentPath?t.parentPath.buildCodeFrameError("Only method call can be used by macro",babel_plugin_macros_1.MacroError):new Error("Only method call can be used by macro");if(!AVAILABLE_METHODS.includes(e))throw t.parentPath?t.parentPath.buildCodeFrameError("Method must be one of ".concat(AVAILABLE_METHODS.join(" or ")),babel_plugin_macros_1.MacroError):new Error("Method must be one of ".concat(AVAILABLE_METHODS.join(" or ")));switch(e){case"createTranslator":var r=s.buildNode(t.parentPath);r&&t.parentPath&&t.parentPath.replaceWith(r);break;case"translate":var a=l.buildNode(t.parentPath);a&&t.parentPath&&t.parentPath.replaceWith(a)}}}))}))}};